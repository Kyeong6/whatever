# 업무내용

- 파이프라인 질문사항 작성

## 7/8

### 질문사항

1. 센서를 통해 얻는 데이터 간격을 어떻게 설정할 것인가?  
   
    - 10분이라고 했을 때 0~10분 데이터를 다 받는 것인지, 아니면 10분 값 하나 만 받는 것인지?
  
    - 결국 웹사이트에서 어떻게 표현할 것인지가 답이 될 것
  
    - 질문에 대한 답변을 통해 DB 선택 가능
  
2. 결과값 데이터 전송 간격도 센서를 통해 얻는 데이터 간격과 동일하게 하면 되는 것인지?
   
3. 현재 관리자가 특정 기간에 데이터를 확보한다고 했는데, 기기에서 사내 중앙 서버로 보내는 과정은 존재하니 중앙 서버에서 따로 DB를 구축해서 기기 별로 데이터 저장하는 것이 어떤지?
    - 관리자가 장치에 접근하여 데이터 확보하는 방법의 모호함에서 비롯된 의문
  
4. 이상치도 예측값으로 전달(알림)하는지? 
    - 실제 이상치일 때 전달인지, 예측값을 통해 얻은 이상치가 나올 경우를 전달하는지?
  
    - 실제 이상치 : 실시간성을 반영한 DB 사용 고려
  
    - 예측값 이상치 : 실시간성 반영 DB 사용 대신 일반적인 DB 사용 고려
<br/></br>

### 파이프라인 구성

![Untitled](https://github.com/Kyeong6/whatever/assets/100195725/a41ae72c-678a-46dd-8306-ebbbc0f00f57)
<br/></br>

**Our works**

| No. | Work | Description |
| --- | --- | --- |
| 1 | 데이터 확인 | Sensor를 통해 얻은 데이터 형식을 확인 |
| 2 | DB 선택 | Raw data를 저장할 데이터베이스 선택 |
| 3 | DB 테이블 구성 및 적재 | Raw data 테이블 구조에 맞게 적재 |
| 4 | DB 조회 후 형식 변환 | DB에 적재된 데이터를 LSTM 모델 예측을 수행할 수 있게 CSV 형식으로 변환 후 Input 디렉토리에 위치 |
| 5 | 데이터 형식 변환 | 예측 수행을 위한 데이터 형식 변환 [0] : 시간(datetime), [1] : 실제값(float) |
| 6 | 예측 수행 | 예측값 저장 : Output/Prediction/prediction.csv<br>이상치 : 10min<br>예측값 : 1hr |
| 7 | 예측값 전송 | CSV(prediction.csv) 파일 API로 전송<br>전송 방식 : requests 라이브러리 사용<br>(전송 방식은 Front 요청에 따라 JSON 형식으로 변환 후 전송할 수 있음) |
| 8 | 예측값 저장 | 예측값을 저장(아래 중 택 1), 설정한 주기가 되면 중앙 서버로 전송,<br>혹은 전송만 하고 중앙서버에 저장 및 처리하는 방식(기기 저장하는 이유 사라짐)<br>1. csv 파일을 특정 디렉토리에 저장<br>2. DB 예측값 컬럼에 값 저장(범위를 통해 조회한 후 전송 진행) |
| 9 | 스케줄러 도입 | 위 과정을 설정한 각 주기에 따라 백그라운드 실행 |

## 7/9

### 질문에 대한 답변

1. 센서를 통해 얻는 데이터 간격을 어떻게 설정할 것인가?

    → 센서는 1분에 한 번씩 데이터 수집 후 DB에 전달

2. 결과값 데이터 전송 간격도 센서를 통해 얻는 데이터 간격과 동일하게 하면 되는 것인지?

    → 결과값 전송(중앙 서버)은 기능 별로 다르다. 예측값은 1일 1회, 이상치는 존재할 경우 전송

3. 현재 관리자가 특정 기간에 데이터를 확보한다고 했는데, 기기에서 사내 중앙 서버로 보내는 과정은 존재하니 중앙 서버에서 따로 DB를 구축해서 기기 별로 데이터 저장하는 것이 어떤지?

    → 백업 개념으로 1년치 데이터를 기기에서 저장

4. 이상치도 예측값으로 전달(알림)하는지? 

    → 이상치는 예측값을 사용하지 않고 1분 간격으로 데이터를 확인하여 이상치 있을 경우(조건) 전송
<br/></br>
### 프로젝트 개발 구성

 **SQLlite3 테이블 구조**

| timestamp | value |
| --- | --- |
| 2024-07-09 0:00 | 224 |
| 2024-07-09 0:01 | 227 |

**기능**

1. 예측값 확인
2. 이상치 확인
3. 데이터 저장

### 프로젝트 개발 단계

**예측값 확인**

| No. | Work | Description |
| --- | --- | --- |
| 1 | 목업 데이터 사용 | Sensor를 통해 얻은 데이터를 대신해 csv 파일에 목업데이터를 설정해 개발 진행 |
| 2 | DB 적재 | 목업데이터를 SQLite3에 적재하는 과정 수행 |
| 3 | CSV 파일 변환 | 특정 시간에 1일(0~24시) 데이터를 조회하여 csv 파일로 변환한 후 Input 디렉토리에 위치 |
| 4 | 데이터 형식 변환 | csv 파일에 존재하는 데이터를 Prediction.py를 실행할 수 있게 데이터 형식 변환<br>timestamp : datetime<br>value : float |
| 5 | 예측 수행 | LSTM 모델을 통한 예측 수행 후 예측값 저장 : Output/Prediction/prediction.csv<br>(1분 데이터를 1시간으로 압축, 총 24 rows) |
| 6 | 예측값 전송 | 1일 1회 CSV(prediction.csv) 파일 API로 전송<br>전송 방식 : requests 라이브러리 사용<br>(전송 방식은 Front 요청에 따라 JSON 형식으로 변환 후 전송할 수 있음) |
| 7 | 스케줄러 도입 | 위 과정을 설정한 주기(1d)에 따라 백그라운드 실행 |
<br/></br>

**이상치 확인**

| No. | Work | Description |
| --- | --- | --- |
| 1 | 목업 데이터 사용 | Sensor를 통해 얻은 데이터를 대신해 csv 파일에 목업데이터를 설정해 개발 진행 |
| 2 | DB 적재 | 목업데이터를 SQLite3에 적재하는 과정 수행 |
| 3 | DB 조회 | 1분마다 DB를 조회하여 해당 값 이상치 유무 판단 진행을 위한 준비 |
| 4 | 이상치 유무 파악 | 이상치 파악 진행한 후 1~4단계일 경우 전송 과정 진행<br>0 : 정상<br>1 ~ 4 : 이상치 4단계 |
| 5 | 데이터 전송 | 이상치일 경우 JSON 파일 형식으로 전달<br>{<br>”machine_number” : 1<br>”time” : 2024-07-09 0:01,<br>”outlier_stage” : 3,<br>”value” : 227<br>}<br>(machine_number 같은 경우 중앙 서버에서 구별할 수 있으면 제거) |
| 6 | 스케줄러 도입 | 위 과정을 설정한 주기(1min)에 따라 백그라운드 실행 |
<br/></br>

**데이터 저장**

| Work | Description |
| --- | --- |
| 데이터 저장(예측값) | 질문사항 |
| 데이터 저장(이상치) | 질문사항 |
| 스케줄러 도입 | 위 과정을 설정한 주기(1min)에 따라 백그라운드 실행 |

### Trouble Shooting

기존에 생각한 방식은 하루의 데이터를 1시간 단위로 나누어 예측을 진행하면 될 것이라고 생각하였으나, 해당 방식은 그저 하루의 예측값을 보내는 것과 다를 바 없다. 왜냐하면 1일 1통신을 진행하기 때문에 결국 일주일 예측값을 보내야 하기 때문이다.   
최종적인 구현을 예를 들면 다음과 같다.  
7월 1일 데이터를 활용해서 7월 2~8일(총 7일) 데이터를 예측하는 데, 이때 각각 1일 24 rows를 가져야 한다.(1시간마다 예측 진행)  
이것을 구현하기 위해서는 7월 1일 기준으로 6월 30일 23시 ~ 7월 1일 00시 데이터를 참고해서 다음 날인 7월 2일의 0 ~ 1시 예측을 진행해야 한다. 즉, 결국 1D + 1H 예측을 진행해야 하는 것이다.   
일주일 간의 예측 방법은 다음과 같이 2가지 방법이 존재한다.

1. 기존 실제 값을 사용하여 2D+1H , 3D+1H… 같이 진행
2. 1D+1H를 실제 값으로 간주하여 다음 날 예측 진행

직관적으로는 실제 값을 기반으로 예측하는 첫 번째 방식이 좋을 것이라고 생각하지만, 1, 2번 방식 모두 테스트하여 좋은 성능을 보이는 것을 채택 필요.

### 질문사항

1. 예측값, 이상치 데이터를 저장할 때 어떤 내용이 존재해야하는가?
2. 자체적으로 이상치 기준을 설정하는데 환경에 따라 바뀌는 데 이것 또한 정의가 되었을 것 같다. 어디에 맞춰서 진행을 하면 좋을지? 개발 단계에서는 구현만 진행해야하는 지?